<% content_for :styles do %>
  <%= stylesheet_link_tag "backoffice/products" %>
<% end %>
<section class="header-section">
  <h1>Administración de Discos</h1>
</section>
<%= render partial: "backoffice/back_button" %>
<section class="filters">
  <%= form_with url: backoffice_products_path, method: :get,
                class: "filters-form",
                data: { controller: "live-search" },
                html: { 'data-live-search-target': 'form' } do %>
    <%= hidden_field_tag :page, params[:page] || 1 %>
    <div class="filters-grid">
      <div class="filter-block">
        <label for="q">Buscar</label>
        <%= text_field_tag :q, params[:q],
              placeholder: "Nombre o Autor",
              class: "filter-input search-input" %>
      </div>
      <div class="filter-block">
        <label for="status">Estado</label>
        <%= select_tag :status,
              options_for_select(
                [["Todos", ""],
                 ["Disponible", "disponible"],
                 ["Sin stock", "sin_stock"],
                 ["Eliminado", "eliminado"]],
                params[:status]),
              class: "filter-select",
              data: { action: "change->live-search#changed" } %>
      </div>
      <div class="filter-block">
        <label for="format">Formato</label>
        <%= select_tag :format,
              options_for_select([["Todos", ""], ["Vinilo", "vinyl"], ["CD", "cd"]],
                params[:format]),
              class: "filter-select",
              data: { action: "change->live-search#changed" } %>
      </div>
      <div class="filter-block">
        <label for="condition">Condición</label>
        <%= select_tag :condition,
              options_for_select(
                [["Todas", ""], ["Usado", "used"], ["Nuevo", "brand_new"]],
                params[:condition]),
              class: "filter-select",
              data: { action: "change->live-search#changed" } %>
      </div>
      <div class="filter-block">
        <label for="from_date">Desde fecha</label>
        <%= date_field_tag :from_date, params[:from_date],
              class: "filter-input",
              data: { action: "change->live-search#changed" } %>
      </div>
      <div class="filter-block">
        <label for="to_date">Hasta fecha</label>
        <%= date_field_tag :to_date, params[:to_date],
              class: "filter-input",
              data: { action: "change->live-search#changed" } %>
      </div>
      <div class="buttons-block">
        <button type="submit" class="icon-btn search" aria-label="Buscar">
          <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
          <span class="sr-only">Buscar</span>
        </button>
        <%= link_to backoffice_products_path,
              class: "icon-btn clear",
              aria: { label: "Limpiar filtros" } do %>
          <i class="fa-solid fa-broom" aria-hidden="true"></i>
          <span class="sr-only">Limpiar</span>
        <% end %>
      </div>
    </div>
  <% end %>
</section>
<% if @products.any? %>
  <%= turbo_frame_tag :products_list do %>
    <table class="records-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Autor</th>
          <th>Formato</th>
          <th>Condición</th>
          <th>Stock</th>
          <th>Estado</th>
          <th class="actions-col">Acciones</th>
        </tr>
      </thead>
      <tbody class="records-body">
        <% @products.each do |p| %>
          <tr class="<%= p.removed_at ? "removed-row" : "" %>">
            <td><%= p.name %></td>
            <td><%= p.author %></td>
            <td><%= p.format_name %></td>
            <td><%= p.condition_name %></td>
            <td>
              <span class="stock-value"><%= p.stock %></span>
            </td>
            <td>
              <% if p.removed_at %>
                <span class="status removed">Eliminado</span>
              <% elsif p.stock == 0 %>
                <span class="status nodata">Sin stock</span>
              <% else %>
                <span class="status ok">Disponible</span>
              <% end %>
            </td>
            <td class="actions">
              <%= link_to backoffice_product_path(p), class: "icon-btn view", aria: { label: "Ver #{p.name}" }, data: { turbo_frame: "_top" } do %>
                <i class="fa-solid fa-eye" aria-hidden="true"></i>
                <span class="sr-only">Ver</span>
              <% end %>
              <%= link_to edit_backoffice_product_path(p), class: "icon-btn warning", aria: { label: "Editar #{p.name}" }, data: { turbo_frame: "_top" } do %>
                <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                <span class="sr-only">Editar</span>
              <% end %>
              <% if p.removed_at %>
                <%= button_to restore_backoffice_product_path(p), method: :patch,
                    class: "icon-btn restore separator-left",
                    aria: { label: "Restaurar #{p.name}" },
                    data: { turbo_confirm: "¿Restaurar #{p.name}?" } do %>
                  <i class="fa-solid fa-rotate-left" aria-hidden="true"></i>
                  <span class="sr-only">Restaurar</span>
                <% end %>
              <% else %>
                <%= button_to soft_delete_backoffice_product_path(p), method: :patch,
                    class: "icon-btn danger separator-left",
                    aria: { label: "Eliminar #{p.name}" },
                    data: { turbo_confirm: "¿Seguro que querés eliminar #{p.name}?" } do %>
                  <i class="fa-solid fa-trash" aria-hidden="true"></i>
                  <span class="sr-only">Eliminar</span>
                <% end %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% end %>
<% else %>
  <div class="empty-state">
    <p>No hay discos para mostrar</p>
  </div>
<% end %>
<div class="pagination wrapper">
<div class="results-info">
  <%= page_entries_info @products, entry_name: 'productos' %>
</div>
<div class="pagination bottom" aria-label="Paginación">
  <%= paginate @products, window: 2, params: request.query_parameters %>
</div>
</div>
<%= link_to new_backoffice_product_path, class: "floating-btn" do %>
  +
<% end %>