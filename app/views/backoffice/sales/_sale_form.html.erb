<%= form_with model: [:backoffice, @sale], local: true, id: "sale-form" do |f| %>
  <% if @sale.errors.any? %>
    <div class="form-errors" role="alert">
      <h3>Errores al crear la venta:</h3>
      <ul>
        <% @sale.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-section">
    <h2>Datos del Cliente</h2>
    <div class="form-grid">
      <div class="form-field">
        <%= f.label :buyer_name, "Nombre", class: "required" %>
        <%= f.text_field :buyer_name, class: "input", required: true, title: "Nombre del comprador" %>
      </div>
      <div class="form-field">
        <%= f.label :buyer_surname, "Apellido", class: "required" %>
        <%= f.text_field :buyer_surname, class: "input", required: true, title: "Apellido del comprador" %>
      </div>
      <div class="form-field">
        <%= f.label :buyer_phone, "Teléfono" %>
        <%= f.text_field :buyer_phone, class: "input", title: "Teléfono del comprador" %>
      </div>
      <div class="form-field">
        <%= f.label :buyer_email, "Email" %>
        <%= f.email_field :buyer_email, class: "input", title: "Email del comprador" %>
      </div>
      <div class="form-field full">
        <%= f.label :buyer_address, "Dirección" %>
        <%= f.text_field :buyer_address, class: "input", title: "Dirección del comprador" %>
      </div>
      <div class="form-field">
        <%= f.label :date, "Fecha", class: "required" %>
        <%= f.date_field :date, class: "input", required: true, title: "Fecha de la venta" %>
      </div>
      <div class="form-field">
        <%= f.label :time, "Hora", class: "required" %>
        <%= f.time_field :time, class: "input", required: true, title: "Hora de la venta", step: 60 %>
      </div>
    </div>
  </div>

  <div class="form-section">
    <h2>Productos</h2>
    <div id="products-container">
      <%# Si @sale tiene productos existentes, f.fields_for los renderiza %>
      <%# Si es nuevo, construimos un sale_product vacío para la plantilla inicial %>
      <% @sale.sale_products.build if @sale.sale_products.empty? %>
      
      <%= f.fields_for :sale_products do |sp_builder| %>
        <%= render 'sale_product_fields', f: sp_builder, available_products: @available_products %>
      <% end %>
    </div>
    
    <%# Template (blueprint) para que JavaScript clone nuevas filas %>
    <template id="sale-product-fields-template">
      <%= f.fields_for :sale_products, SaleProduct.new, child_index: 'NEW_RECORD' do |sp_builder| %>
        <%= render 'sale_product_fields', f: sp_builder, available_products: @available_products %>
      <% end %>
    </template>
    
    <button type="button" id="add-product-btn" class="btn-add-product">
      <i class="fa-solid fa-plus"></i> Agregar Producto
    </button>
  </div>

  <div class="form-section">
    <div class="total-section">
      <h2>Total de la Venta: <span id="total-amount">$0.00</span></h2>
    </div>
  </div>

  <div class="form-actions">
    <%= f.submit "Crear Venta", class: "btn-submit", id: "submit-sale" %>
  </div>
<% end %>

<script type="application/json" id="products-data">
<%= @available_products.each_with_object({}) { |product, hash| hash[product.id] = { price: product.price, stock: product.stock, name: "#{product.name} - #{product.author}" } }.to_json.html_safe %>
</script>

<%= javascript_include_tag "sale_form", defer: false %>
